

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>olympus.emulators.emulator &mdash; Olympus 0+unknown documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/msmb.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
        <script src="../../../_static/js/versions.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo2b.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0+unknown
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../support.html">Support</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/notebooks/use_emulators.html">Experiment emulators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/notebooks/simple_benchmark.html">Run a simple benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/notebooks/larger_benchmarks.html">Run a larger benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/notebooks/planners_interface.html">Planners Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/notebooks/noisy_inputs.html">Noisy Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/notebooks/custom_dataset.html">Custom Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/notebooks/custom_planner.html">Custom Planner</a></li>
</ul>
<p class="caption"><span class="caption-text">Core Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../classes/planners/index.html">Planners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes/datasets/index.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes/models/index.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes/emulators.html">Emulators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes/surfaces/index.html">Surfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes/noises/index.html">Noises</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../custom_emulators.html">Custom Emulators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../custom_planners.html">Custom Planners</a></li>
</ul>
<p class="caption"><span class="caption-text">Complete API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/olympus.html">olympus package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Olympus</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>olympus.emulators.emulator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for olympus.emulators.emulator</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>

<span class="kn">from</span> <span class="nn">olympus</span> <span class="kn">import</span> <span class="n">__emulator_path__</span><span class="p">,</span> <span class="n">__scratch__</span><span class="p">,</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">olympus.datasets.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">olympus.models.model</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">olympus.models.abstract_model</span> <span class="kn">import</span> <span class="n">AbstractModel</span>
<span class="kn">from</span> <span class="nn">olympus.objects</span> <span class="kn">import</span> <span class="n">Object</span><span class="p">,</span> <span class="n">ParameterVector</span>
<span class="kn">from</span> <span class="nn">olympus.utils.data_transformer</span> <span class="kn">import</span> <span class="n">DataTransformer</span>
<span class="kn">from</span> <span class="nn">olympus.models.model</span> <span class="kn">import</span> <span class="n">_validate_model_kind</span>
<span class="kn">from</span> <span class="nn">olympus.datasets.dataset</span> <span class="kn">import</span> <span class="n">_validate_dataset_args</span>


<span class="c1"># =========================</span>
<span class="c1"># Main Class of This Module</span>
<span class="c1"># =========================</span>
<div class="viewcode-block" id="Emulator"><a class="viewcode-back" href="../../../classes/emulators.html#olympus.emulators.emulator.Emulator">[docs]</a><span class="k">class</span> <span class="nc">Emulator</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; generic experiment emulator</span>

<span class="sd">    This class is intended to provide the interface to the user.</span>

<span class="sd">    Random notes:</span>
<span class="sd">    - emulators are uniquely determined via dataset + model + emulator_id</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_transform</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span>
        <span class="n">target_transform</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Experiment emulator.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (str, Dataset): dataset used to train a model. Either a string, in which case a standard dataset</span>
<span class="sd">                is loaded, or a Dataset object. To see the list of available datasets ...</span>
<span class="sd">            model (str, Model): the model used to create the emulator. Either a string, in which case a default model</span>
<span class="sd">                is loaded, or a Model object. To see the list of available models ...</span>
<span class="sd">            feature_transform (str, list): the data transform to be applied to the features. See DataTransformer for the</span>
<span class="sd">                available transformations.</span>
<span class="sd">            target_transform (str, list): the data transform to be applied to the targets. See DataTransformer for the</span>
<span class="sd">                available transformations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># if dataset and model are strings ==&gt; load emulator from file</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="c1"># check dataset string</span>
            <span class="n">_validate_dataset_args</span><span class="p">(</span>
                <span class="n">kind</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
            <span class="c1"># check model string</span>
            <span class="n">_validate_model_kind</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Loading emulator using a </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> model for the dataset </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span>
                <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">__emulator_path__</span><span class="si">}</span><span class="s2">/emulator_</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># -----------------------------------------</span>
        <span class="c1"># otherwise, assume it is a custom emulator</span>
        <span class="c1"># -----------------------------------------</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

            <span class="c1"># other attributes we will use</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">__version__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ghost_model</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_trained</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cross_val_performed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_scores</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emulator_to_save</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_transformer</span> <span class="o">=</span> <span class="n">DataTransformer</span><span class="p">(</span>
                <span class="n">transformations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_transform</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_transformer</span> <span class="o">=</span> <span class="n">DataTransformer</span><span class="p">(</span>
                <span class="n">transformations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_transform</span>
            <span class="p">)</span>

        <span class="c1"># create tmp dir to store model files</span>
        <span class="c1"># also if we are loading a model (the user could call &#39;train&#39; again)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scratch_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">__scratch__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;emulator_&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Emulator (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="si">}</span><span class="s2">, model=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">)&gt;&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Emulator (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="si">}</span><span class="s2">)&gt;&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Emulator (model=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">)&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Emulator (unspecified)&gt;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">goal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">goal</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_space</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">param_space</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value_space</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">value_space</span>

    <span class="c1"># ===========</span>
    <span class="c1"># Set Methods</span>
    <span class="c1"># ===========</span>
    <span class="k">def</span> <span class="nf">_set_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; registers a dataset for emulator</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (str): name of available dataset, or Dataset object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="c1"># check that the param_space is defined</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">param_space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The param_space information is not present in the Dataset object provided. Please use &quot;</span>
                <span class="s2">&quot;Dataset.set_param_space to define the type of variables present in the dataset before &quot;</span>
                <span class="s2">&quot;instantiating the Emulator.&quot;</span>
            <span class="p">)</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; registers a model for emulator</span>

<span class="sd">        Args:</span>
<span class="sd">            model (str): name of available model, or a model object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">AbstractModel</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="c1"># self.param_space is taken from self.dataset.param_space, so...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_param_space</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_param_space</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_space</span><span class="p">)</span>

    <span class="c1"># =========================</span>
    <span class="c1"># Train and Predict Methods</span>
    <span class="c1"># =========================</span>
    <span class="k">def</span> <span class="nf">cross_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rerun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># TODO: allow setting verbosity: verbose=True/False will be enough</span>
        <span class="sd">&quot;&quot;&quot;Performs cross validation on the emulator dataset, using the emulator model. The number of folds used is</span>
<span class="sd">        defined in the Dataset object.</span>

<span class="sd">        Args:</span>
<span class="sd">            rerun (bool): whether to run cross validation again, in case it had already been performed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            scores (dict): dictionary with the list of train and validation R2 scores.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;Perform cross validation.</span>

<span class="sd">        Returns (dict): dictionary containing the training and test R2 scores for all folds.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_val_performed</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">rerun</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Cross validation has already been performed for this Emulator. You can see its results in &quot;</span>
                <span class="s2">&quot;`self.cv_scores`. If you would like to rerun cross validation and overwrite the previous &quot;</span>
                <span class="s2">&quot;results, set `rerun` to True&quot;</span>
            <span class="p">)</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;FATAL&quot;</span><span class="p">)</span>

        <span class="n">training_r2_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_folds</span><span class="p">)</span>
        <span class="n">valid_r2_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_folds</span><span class="p">)</span>
        <span class="n">training_rmsd_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_folds</span><span class="p">)</span>
        <span class="n">valid_rmsd_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_folds</span><span class="p">)</span>

        <span class="c1"># get scaled train/valid sets</span>
        <span class="c1"># NOTE: we do not want to use the self.transformers, because for &#39;run&#39; we want to use the transformers</span>
        <span class="c1"># trained in &#39;train&#39;. If we reset the Transformers here, then if a user calls &#39;cross_validate&#39; after &#39;train&#39;</span>
        <span class="c1"># we end up using the wrong transformers in &#39;run&#39;</span>
        <span class="n">feature_transformer</span> <span class="o">=</span> <span class="n">DataTransformer</span><span class="p">(</span><span class="n">transformations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_transform</span><span class="p">)</span>
        <span class="n">target_transformer</span> <span class="o">=</span> <span class="n">DataTransformer</span><span class="p">(</span><span class="n">transformations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_transform</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------</span>
        <span class="c1"># Iterate over the cross validation folds</span>
        <span class="c1"># ---------------------------------------</span>
        <span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_folds</span><span class="p">):</span>
            <span class="c1"># get the train/valid sets</span>
            <span class="c1"># NOTE: we keep the features as Dataset objects, as these are needed for possible periodic transformations</span>
            <span class="c1"># TODO: expend the above also to targets? Right now param_space does not describe what type of variable</span>
            <span class="c1">#  the targets are</span>
            <span class="n">train_features</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">cross_val_sets_features</span><span class="p">[</span><span class="n">fold</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">train_features</span><span class="o">.</span><span class="n">set_param_space</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">param_space</span><span class="p">)</span>
            <span class="n">valid_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">cross_val_sets_features</span><span class="p">[</span><span class="n">fold</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">train_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">cross_val_sets_targets</span><span class="p">[</span><span class="n">fold</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">valid_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">cross_val_sets_targets</span><span class="p">[</span><span class="n">fold</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

            <span class="n">feature_transformer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_features</span><span class="p">)</span>
            <span class="n">target_transformer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_targets</span><span class="p">)</span>

            <span class="n">train_features_scaled</span> <span class="o">=</span> <span class="n">feature_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_features</span><span class="p">)</span>
            <span class="n">valid_features_scaled</span> <span class="o">=</span> <span class="n">feature_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">valid_features</span><span class="p">)</span>
            <span class="n">train_targets_scaled</span> <span class="o">=</span> <span class="n">target_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_targets</span><span class="p">)</span>
            <span class="n">valid_targets_scaled</span> <span class="o">=</span> <span class="n">target_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">valid_targets</span><span class="p">)</span>

            <span class="c1"># define scope and make a copy of the model for the cross validation</span>
            <span class="n">model_fold</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ghost_model</span>
            <span class="p">)</span>  <span class="c1"># the model we will use for training the fold</span>
            <span class="n">model_fold</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Fold_</span><span class="si">{</span><span class="n">fold</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_scratch_dir</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_fold</span><span class="o">.</span><span class="n">scope</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># TODO/QUESTION: in case we are overwriting the output of a previous call, should we first remove the folder</span>
            <span class="c1">#  to make sure to have a cleared path?</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

            <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; Training model on fold #</span><span class="si">{</span><span class="n">fold</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
            <span class="p">(</span>
                <span class="n">mdl_train_r2</span><span class="p">,</span>
                <span class="n">mdl_valid_r2</span><span class="p">,</span>
                <span class="n">mdl_train_rmsd</span><span class="p">,</span>
                <span class="n">mdl_test_rmsd</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">model_fold</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
                <span class="n">train_features</span><span class="o">=</span><span class="n">train_features_scaled</span><span class="p">,</span>
                <span class="n">train_targets</span><span class="o">=</span><span class="n">train_targets_scaled</span><span class="p">,</span>
                <span class="n">valid_features</span><span class="o">=</span><span class="n">valid_features_scaled</span><span class="p">,</span>
                <span class="n">valid_targets</span><span class="o">=</span><span class="n">valid_targets_scaled</span><span class="p">,</span>
                <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># store performance of fold</span>
            <span class="n">training_r2_scores</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdl_train_r2</span>
            <span class="n">valid_r2_scores</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdl_valid_r2</span>
            <span class="n">training_rmsd_scores</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdl_train_rmsd</span>
            <span class="n">valid_rmsd_scores</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdl_test_rmsd</span>
            <span class="c1"># write file to indicate training is complete and add R2 in there</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">/training_completed.info&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">content</span><span class="p">:</span>
                <span class="n">content</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Train R2=</span><span class="si">{</span><span class="n">mdl_train_r2</span><span class="si">}</span><span class="se">\n</span><span class="s2">Validation R2=</span><span class="si">{</span><span class="n">mdl_valid_r2</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Train RMSD=</span><span class="si">{</span><span class="n">mdl_train_rmsd</span><span class="si">}</span><span class="se">\n</span><span class="s2">Validation RMSD=</span><span class="si">{</span><span class="n">mdl_test_rmsd</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="c1"># print some info to screen</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance statistics based on transformed data &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_transform</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_transform</span><span class="si">}</span><span class="s2">]:&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">cv_r2_score_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valid_r2_scores</span><span class="p">)</span>
        <span class="n">cv_r2_score_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">valid_r2_scores</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_r2_scores</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">cv_rmsd_score_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valid_rmsd_scores</span><span class="p">)</span>
        <span class="n">cv_rmsd_score_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">valid_rmsd_scores</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_rmsd_scores</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s2">&quot;Validation   R2: </span><span class="si">{0:.4f}</span><span class="s2"> +/- </span><span class="si">{1:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">cv_r2_score_mean</span><span class="p">,</span> <span class="n">cv_r2_score_stderr</span>
            <span class="p">),</span>
            <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s2">&quot;Validation RSMD: </span><span class="si">{0:.4f}</span><span class="s2"> +/- </span><span class="si">{1:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">cv_rmsd_score_mean</span><span class="p">,</span> <span class="n">cv_rmsd_score_stderr</span>
            <span class="p">),</span>
            <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cross_val_performed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;train_r2&quot;</span><span class="p">:</span> <span class="n">training_r2_scores</span><span class="p">,</span>
            <span class="s2">&quot;validate_r2&quot;</span><span class="p">:</span> <span class="n">valid_r2_scores</span><span class="p">,</span>
            <span class="s2">&quot;train_rmsd&quot;</span><span class="p">:</span> <span class="n">training_rmsd_scores</span><span class="p">,</span>
            <span class="s2">&quot;validate_rmsd&quot;</span><span class="p">:</span> <span class="n">valid_rmsd_scores</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">retrain</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># TODO: allow setting verbosity: verbose=True/False will be enough</span>
        <span class="sd">&quot;&quot;&quot;Trains the model on the emulator dataset, using the emulator model. The train/test split is defined in the</span>
<span class="sd">        Dataset object `emulator.dataset`. Note that the test set is used for testing the model performance, and for</span>
<span class="sd">        early stopping.</span>

<span class="sd">        Args:</span>
<span class="sd">            plot (bool):</span>
<span class="sd">            retrain (bool): whether to retrain the model, in case it had already been trained.</span>

<span class="sd">        Returns:</span>
<span class="sd">            scores (dict): dictionary with the train and test R2 scores.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if this emulator has already been trained</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_trained</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">retrain</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The Emulator is already trained. If you would like to overwrite the already trained emulator, &quot;</span>
                <span class="s2">&quot;set `retrain` to True&quot;</span>
            <span class="p">)</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;FATAL&quot;</span><span class="p">)</span>

        <span class="c1"># get the train/test sets</span>
        <span class="c1"># NOTE: we keep the features as Dataset objects, as these are needed for possible periodic transformations</span>
        <span class="c1"># TODO: expend the above also to targets? Right now param_space does not describe what type of variable</span>
        <span class="c1">#  the targets are</span>
        <span class="n">train_features</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">train_set_features</span><span class="p">)</span>
        <span class="n">train_features</span><span class="o">.</span><span class="n">set_param_space</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">param_space</span><span class="p">)</span>
        <span class="n">test_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">test_set_features</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">train_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">train_set_targets</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">test_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">test_set_targets</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># get scaled train/valid sets. These are also the DataTransformer objects we keep as they are needed in &#39;run&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_transformer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_transformer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_targets</span><span class="p">)</span>

        <span class="n">train_features_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_features</span><span class="p">)</span>
        <span class="n">test_features_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_features</span><span class="p">)</span>
        <span class="n">train_targets_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_targets</span><span class="p">)</span>
        <span class="n">test_targets_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_targets</span><span class="p">)</span>

        <span class="c1"># define path where to store model</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_scratch_dir</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/Model&quot;</span>
        <span class="c1"># TODO/QUESTION: in case we are overwriting the output of a previous call, should we first remove the folder</span>
        <span class="c1">#  to make sure to have a cleared path?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

        <span class="c1"># Train</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s2">&quot;&gt;&gt;&gt; Training model on </span><span class="si">{0:.0%}</span><span class="s2"> of the dataset, testing on </span><span class="si">{1:.0%}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">test_frac</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">test_frac</span>
            <span class="p">),</span>
            <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mdl_train_r2</span><span class="p">,</span> <span class="n">mdl_test_r2</span><span class="p">,</span> <span class="n">mdl_train_rmsd</span><span class="p">,</span> <span class="n">mdl_test_rmsd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
            <span class="n">train_features</span><span class="o">=</span><span class="n">train_features_scaled</span><span class="p">,</span>
            <span class="n">train_targets</span><span class="o">=</span><span class="n">train_targets_scaled</span><span class="p">,</span>
            <span class="n">valid_features</span><span class="o">=</span><span class="n">test_features_scaled</span><span class="p">,</span>
            <span class="n">valid_targets</span><span class="o">=</span><span class="n">test_targets_scaled</span><span class="p">,</span>
            <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># write file to indicate training is complete and add R2 in there</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">/training_completed.info&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">content</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Train R2=</span><span class="si">{</span><span class="n">mdl_train_r2</span><span class="si">}</span><span class="se">\n</span><span class="s2">Validation R2=</span><span class="si">{</span><span class="n">mdl_test_r2</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Train RMSD=</span><span class="si">{</span><span class="n">mdl_train_rmsd</span><span class="si">}</span><span class="se">\n</span><span class="s2">Validation RMSD=</span><span class="si">{</span><span class="n">mdl_test_rmsd</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance statistics based on transformed data &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_transform</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_transform</span><span class="si">}</span><span class="s2">]:&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Train R2   Score: </span><span class="si">{0:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mdl_train_r2</span><span class="p">),</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Test  R2   Score: </span><span class="si">{0:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mdl_test_r2</span><span class="p">),</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Train RMSD Score: </span><span class="si">{0:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mdl_train_rmsd</span><span class="p">),</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Test  RMSD Score: </span><span class="si">{0:.4f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mdl_test_rmsd</span><span class="p">),</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>

        <span class="c1"># set is_trained to True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_trained</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># show stats on untransformed samples</span>
        <span class="c1"># -----------------------------------</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">train_set_targets</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">y_train_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">train_set_features</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">y_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">test_set_targets</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">y_test_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">test_set_features</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">train_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
        <span class="n">train_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y_train</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="n">y_train_pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">test_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
        <span class="n">test_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="n">y_test_pred</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance statistics based on original data:&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Train R2   Score: </span><span class="si">{0:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_r2</span><span class="p">),</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Test  R2   Score: </span><span class="si">{0:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_r2</span><span class="p">),</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Train RMSD Score: </span><span class="si">{0:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_rmse</span><span class="p">),</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Test  RMSD Score: </span><span class="si">{0:.4f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_rmse</span><span class="p">),</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>

        <span class="c1"># save and return scores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_scores</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;train_r2&quot;</span><span class="p">:</span> <span class="n">mdl_train_r2</span><span class="p">,</span>
            <span class="s2">&quot;test_r2&quot;</span><span class="p">:</span> <span class="n">mdl_test_r2</span><span class="p">,</span>
            <span class="s2">&quot;train_rmsd&quot;</span><span class="p">:</span> <span class="n">mdl_train_rmsd</span><span class="p">,</span>
            <span class="s2">&quot;test_rmsd&quot;</span><span class="p">:</span> <span class="n">mdl_test_rmsd</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_scores</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_paramvector</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the emulator and return a value given the features provided.</span>

<span class="sd">        Args:</span>
<span class="sd">            features (ndarray): 2d array with the input features used for the predictions</span>
<span class="sd">            num_samples (int): number of samples to average. only useful for probabilistic models</span>
<span class="sd">            return_paramvector (bool): Whether to return a ``ParameterVector`` object instead of a list of lists.</span>
<span class="sd">                Default is False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            y (float or array): model prediction(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># first check if we have a trained model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_trained</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;This emulator has not been trained yet. Please train the emulator before you can use it for prediction.&quot;</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>

        <span class="c1"># check the inputs</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># validate features</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_space</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Dimensions of provided features (</span><span class="si">%d</span><span class="s2">) did not match expected dimension (</span><span class="si">%d</span><span class="s2">)&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_space</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_space</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Not all parameters are within bounds&quot;</span>
                <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>

        <span class="c1"># scale the features using the DataTransformer that was fit when training</span>
        <span class="n">features_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="c1"># predict, drawing a certain amount of samples</span>
        <span class="n">y_pred_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features_scaled</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>

        <span class="c1"># return the prediction after inverting the transform</span>
        <span class="n">y_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_transformer</span><span class="o">.</span><span class="n">back_transform</span><span class="p">(</span>
            <span class="n">y_pred_scaled</span>
        <span class="p">)</span>  <span class="c1"># this is a 2d array</span>

        <span class="c1"># if we are not asking for a ParamVector, we can just return y_preds</span>
        <span class="k">if</span> <span class="n">return_paramvector</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y_preds</span>

        <span class="c1"># NOTE: while we do not allow batches or multiple objectives yet, this code is supposed to be able to support</span>
        <span class="c1">#  those</span>
        <span class="n">y_pred_objects</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of ParamVectors with all samples and objectives</span>
        <span class="c1"># iterate over all samples (if we returned a batch of predictions)</span>
        <span class="k">for</span> <span class="n">y_pred</span> <span class="ow">in</span> <span class="n">y_preds</span><span class="p">:</span>
            <span class="n">y_pred_object</span> <span class="o">=</span> <span class="n">ParameterVector</span><span class="p">()</span>
            <span class="c1"># iterate over all objectives/targets</span>
            <span class="k">for</span> <span class="n">target_name</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">target_names</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
                <span class="n">y_pred_object</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">target_name</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>
            <span class="c1"># append object to list</span>
            <span class="n">y_pred_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_pred_object</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">y_pred_objects</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./olympus_emulator&quot;</span><span class="p">,</span> <span class="n">include_cv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the emulator in a specified location. This will save the emulator object as a pickle file, and the</span>
<span class="sd">        associated TensorFlow model, in the specified location. The saved emulator can then be loaded with the</span>
<span class="sd">        `olympus.emulators.load_emulator` function.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): relative path where to save the emulator.</span>
<span class="sd">            include_cv (bool): whether to include the cross validation models. Default is False.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: check if path corresponds to one of our emulators and in that case raise error?</span>

        <span class="c1"># create path, or overwrite existing one</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Overwriting existing emulator in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">!&quot;</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emulator_to_save</span> <span class="o">=</span> <span class="n">Emulator</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
<span class="c1">#            skip = [</span>
                <span class="c1">#                &#39;me&#39;,</span>
                <span class="c1">#                &#39;indent&#39;,</span>
                <span class="c1">#                &#39;props&#39;,</span>
                <span class="c1">#                &#39;attrs&#39;,</span>
                <span class="c1">#                &#39;max_prop_len&#39;,</span>
                <span class="c1">#                &#39;dataset&#39;,</span>
                <span class="c1">#                &#39;model&#39;,</span>
                <span class="c1">#                &#39;feature_transform&#39;,</span>
                <span class="c1">#                &#39;target_transform&#39;,</span>
                <span class="c1">#                &#39;_version&#39;,</span>
                <span class="c1">#                &#39;_ghost_model&#39;,</span>
                <span class="c1">#                &#39;is_trained&#39;,</span>
                <span class="c1">#                &#39;cross_val_performed&#39;,</span>
                <span class="c1">#                &#39;cv_scores&#39;,</span>
                <span class="c1">#                &#39;model_scores&#39;,</span>
                <span class="c1">#                &#39;emulator_to_save&#39;,</span>
                <span class="c1">#                &#39;feature_transformer&#39;,</span>
                <span class="c1">#                &#39;target_transformer&#39;,</span>
                <span class="c1">#                &#39;_scratch_dir&#39;]</span>
<span class="c1">#            ]</span>
<span class="c1">#            if key in skip:</span>
<span class="c1">#                continue</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;model&quot;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emulator_to_save</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ghost_model</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;emulator_to_save&quot;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emulator_to_save</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emulator_to_save</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># pickle emulator object</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/emulator.pickle&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emulator_to_save</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="c1"># copy over model files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_trained</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_scratch_dir</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/Model&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/Model&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;The emulator you are saving has not been trained. Its model-related files will not be written to disk.&quot;</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>

        <span class="c1"># if include_cv is True ==&gt; copy also CV models</span>
        <span class="k">if</span> <span class="n">include_cv</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_val_performed</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_scratch_dir</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/Fold*&quot;</span><span class="p">):</span>
                    <span class="n">dirname</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;You are trying to save the cross validation models for an emulator that did not perform &quot;</span>
                    <span class="s2">&quot;cross validation. No cross validation models to be saved.&quot;</span>
                <span class="p">)</span>
                <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: also dump some info in human readable format? json like we had before?</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emulator_folder</span><span class="p">):</span>
        <span class="n">emulator</span> <span class="o">=</span> <span class="n">load_emulator</span><span class="p">(</span><span class="n">emulator_folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">emulator</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span></div>


<span class="c1"># ===============</span>
<span class="c1"># Other Functions</span>
<span class="c1"># ===============</span>
<span class="k">def</span> <span class="nf">load_emulator</span><span class="p">(</span><span class="n">emulator_folder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads a previously saved emulator.</span>

<span class="sd">    Args:</span>
<span class="sd">        emulator_folder (str): path to the folder where the emulator was saved.</span>

<span class="sd">    Returns:</span>
<span class="sd">        emulator (Emulator): emulator object loaded from file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check path exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">emulator_folder</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Folder &quot;</span><span class="si">{</span><span class="n">emulator_folder</span><span class="si">}</span><span class="s1">&quot; does not exist&#39;</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;FATAL&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emulator_folder</span><span class="si">}</span><span class="s2">/emulator.pickle&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">emulator_stored</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Failed to restore emulator&quot;</span><span class="p">,</span> <span class="s2">&quot;FATAL&quot;</span><span class="p">)</span>

    <span class="n">emulator_to_load</span> <span class="o">=</span> <span class="n">Emulator</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">emulator_stored</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">emulator_to_load</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">emulator_to_load</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">emulator_stored</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Key &quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot; from Emulator of olympus v.</span><span class="si">{</span><span class="n">emulator_stored</span><span class="o">.</span><span class="n">_version</span><span class="si">}</span><span class="s1"> not found in Emulator &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;class of olympus v.</span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s1">). Attribute &quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot; will not be set.&#39;</span>
            <span class="p">)</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">emulator_to_load</span><span class="o">.</span><span class="n">is_trained</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">emulator_to_load</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_set_dims</span><span class="p">(</span>
            <span class="n">features_dim</span><span class="o">=</span><span class="n">emulator_to_load</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">features_dim</span><span class="p">,</span>
            <span class="n">targets_dim</span><span class="o">=</span><span class="n">emulator_to_load</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">targets_dim</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">restored</span> <span class="o">=</span> <span class="n">emulator_to_load</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emulator_folder</span><span class="si">}</span><span class="s2">/Model&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">restored</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;failed to restore model&quot;</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>

    <span class="c1"># NOTE: we are not leading any cross validation models for the moment. If CV was performed though, we still have</span>
    <span class="c1"># the data about the CV performance</span>
    <span class="k">return</span> <span class="n">emulator_to_load</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Matteo Aldeghi, Riley Hickman and Florian Hse.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  <script>
    var versions_json_url = ''
</script>

<div class="rst-versions" data-toggle="rst-versions" role="note"
     aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"></span>
        0+unknown
      <span class="fa fa-caret-down"></span>
    </span>

    <div class="rst-other-versions">
        <dl id="versionselector">
            <dt>Other Versions</dt>
        </dl>

    </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>